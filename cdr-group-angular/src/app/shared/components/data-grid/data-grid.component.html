<div class="data-grid-container">
  <!-- Header Section -->
  @if (config.title || config.addButton) {
    <div class="grid-header">
      <div class="header-content">
        @if (config.title) {
          <h1>{{ config.title | translate }}</h1>
        }
        @if (config.subtitle) {
          <p>{{ config.subtitle | translate }}</p>
        }
      </div>
      @if (config.addButton) {
        <button mat-raised-button [color]="config.addButton.color || 'primary'" (click)="addClick.emit()">
          @if (config.addButton.icon) {
            <mat-icon>{{ config.addButton.icon }}</mat-icon>
          }
          {{ config.addButton.label | translate }}
        </button>
      }
    </div>
  }

  <!-- Filters Section -->
  @if (config.filters?.length || config.showSearch !== false) {
    <div class="filters-section">
      <div class="filters-container">
        <!-- Search Field -->
        @if (config.showSearch !== false) {
          <div class="search-wrapper">
            <mat-icon class="search-icon">search</mat-icon>
            <input
              class="search-input"
              [(ngModel)]="searchTerm"
              (keyup)="onSearchKeyup($event)"
              [placeholder]="config.searchPlaceholder || ('common.searchPlaceholder' | translate)">
            @if (searchTerm) {
              <button class="clear-search" (click)="searchTerm = ''; onSearch()">
                <mat-icon>close</mat-icon>
              </button>
            }
          </div>
        }

        <!-- Dynamic Filters -->
        @if (config.filters?.length) {
          <div class="filters-group">
            @for (filter of config.filters; track filter.key) {
              <div class="filter-item">
                @switch (filter.type) {
                  @case ('text') {
                    <mat-form-field appearance="outline" [style.width]="filter.width || '180px'">
                      <mat-label>{{ filter.label | translate }}</mat-label>
                      <input matInput
                             [(ngModel)]="filterValues[filter.key]"
                             [placeholder]="filter.placeholder || '' | translate">
                      @if (filter.icon) {
                        <mat-icon matSuffix>{{ filter.icon }}</mat-icon>
                      }
                    </mat-form-field>
                  }

                  @case ('select') {
                    <mat-form-field appearance="outline" [style.width]="filter.width || '180px'">
                      <mat-label>{{ filter.label | translate }}</mat-label>
                      <mat-select [(value)]="filterValues[filter.key]">
                        @for (option of filter.options; track option.value) {
                          <mat-option [value]="option.value">{{ option.label | translate }}</mat-option>
                        }
                      </mat-select>
                    </mat-form-field>
                  }

                  @case ('date') {
                    <mat-form-field appearance="outline" [style.width]="filter.width || '180px'">
                      <mat-label>{{ filter.label | translate }}</mat-label>
                      <input matInput
                             [matDatepicker]="picker"
                             [(ngModel)]="filterValues[filter.key]"
                             [placeholder]="filter.placeholder || '' | translate">
                      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                      <mat-datepicker #picker></mat-datepicker>
                    </mat-form-field>
                  }

                  @case ('checkbox') {
                    <div class="toggle-filter">
                      <mat-slide-toggle [(ngModel)]="filterValues[filter.key]">
                        {{ filter.label | translate }}
                      </mat-slide-toggle>
                    </div>
                  }
                }
              </div>
            }
          </div>
        }

        <!-- Filter Actions -->
        <div class="filter-actions">
          <button mat-flat-button color="primary" (click)="applyFilters()">
            <mat-icon>filter_list</mat-icon>
            <span>{{ 'common.apply' | translate }}</span>
          </button>
          <button mat-stroked-button (click)="clearFilters()">
            <mat-icon>refresh</mat-icon>
            <span>{{ 'common.clear' | translate }}</span>
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Table Section -->
  <div class="table-wrapper">
    <!-- Loading Overlay -->
    @if (loading) {
      <div class="loading-overlay">
        <div class="loading-content">
          <mat-spinner diameter="40"></mat-spinner>
          <span>{{ 'common.loading' | translate }}</span>
        </div>
      </div>
    }
    <table mat-table [dataSource]="dataSource" matSort (matSortChange)="onSortChange($event)">

      <!-- Dynamic Columns -->
      @for (col of config.columns; track col.key) {
        <ng-container [matColumnDef]="col.key">
          <th mat-header-cell *matHeaderCellDef [mat-sort-header]="col.sortable ? col.key : ''" [style.width]="col.width">
            {{ col.header | translate }}
          </th>
          <td mat-cell *matCellDef="let row">
            @if (col.badge) {
              <span class="status-badge"
                    [class.badge-primary]="col.badge(row).color === 'primary'"
                    [class.badge-accent]="col.badge(row).color === 'accent'"
                    [class.badge-warn]="col.badge(row).color === 'warn'"
                    [class.badge-success]="col.badge(row).color === 'success'"
                    [class.badge-info]="col.badge(row).color === 'info'">
                {{ col.badge(row).text | translate }}
              </span>
            } @else if (col.type === 'date') {
              {{ (col.cell ? col.cell(row) : row[col.key]) | date:(col.dateFormat || 'mediumDate') }}
            } @else {
              {{ col.cell ? col.cell(row) : row[col.key] }}
            }
          </td>
        </ng-container>
      }

      <!-- Actions Column -->
      @if (config.actions?.length) {
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>{{ 'common.actions' | translate }}</th>
          <td mat-cell *matCellDef="let row" class="actions-cell">
            @for (action of config.actions; track action.icon) {
              @if (isActionVisible(action, row)) {
                <button mat-icon-button
                        class="action-btn"
                        [class.primary]="action.color === 'primary'"
                        [class.accent]="action.color === 'accent'"
                        [class.warn]="action.color === 'warn'"
                        [class.success]="action.color === 'success'"
                        [class.info]="action.color === 'info'"
                        [matTooltip]="action.tooltip | translate"
                        matTooltipClass="action-tooltip"
                        (click)="action.onClick(row)">
                  <mat-icon>{{ action.icon }}</mat-icon>
                </button>
              }
            }
          </td>
        </ng-container>
      }

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      <!-- No Data Row -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
          <div class="empty-state">
            <mat-icon>inbox</mat-icon>
            <span>{{ 'common.noData' | translate }}</span>
          </div>
        </td>
      </tr>
    </table>

    <mat-paginator
      class="modern-paginator"
      [length]="totalCount || data.length"
      [pageSize]="config.defaultPageSize || pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="config.pageSizeOptions || [5, 10, 25, 50]"
      [showFirstLastButtons]="true"
      [selectConfig]="{ panelClass: 'paginator-select-panel' }"
      (page)="onPageChange($event)"
      aria-label="Select page">
    </mat-paginator>
  </div>
</div>
